<include file="Public:header" />
<!-- Sidebar begins -->
<div id="sidebar">
	<include file="Public:left" />
	<!-- Secondary nav -->
</div>
<!-- Sidebar ends -->

<script language="javascript" type="text/javascript" src="__JS__/My97DatePicker/WdatePicker.js"></script>
<script src="__JS__/dialog/artDialog.js?skin=default"></script>

<script type="text/javascript" charset="utf-8" src="__JS__/ueditor1_4_3-utf8-php/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="__JS__/ueditor1_4_3-utf8-php/ueditor.all.min.js"> </script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="__JS__/ueditor1_4_3-utf8-php/lang/zh-cn/zh-cn.js"></script>

<!-- Content begins -->
<div id="content">

  <include file="Public:bav" />
  
    <!-- Main content -->
    <div class="wrapper">
    	<div class="fluid">
        <!-- Media table sample -->
        <div class="widget check">
        <div class="whead">
        	<h6>编辑资讯</h6>
        	<empty name="Think.get.backurl">
	        	<a href="{:getCurrentUrl()}" class="buttonH bBlue mb10 mt5">返回</a>
	        <else />
	           	<a href="{$Think.get.backurl}" class="buttonH bBlue mb10 mt5">返回</a>
	        </empty>
        	<div class="clear"></div>
        </div>
        <div class="body">
        	<form method='post' id="form1" name="form1" action="{:U('News/updateNews')}"  enctype="multipart/form-data">
	        <div class="formRow">
		        <div class="grid2"><label>标题:</label></div>
		        <div class="grid9"><input type="text" name="name" value="{$vo.name}" placeholder="标题"></div>
		        <div class="clear"></div>
	        </div>
	        <div class="formRow">
		        <div class="grid2" ><label>副标题:</label></div>
		        <div class="grid9"><input type="text" name="sub_title" value="{$vo.sub_title}" placeholder="副标题"></div>
		        <div class="clear"></div>
	        </div>
	        <div class="formRow">
		        <div class="grid2" ><label>摘要:</label></div>
		        <div class="grid9"><textarea rows="4" placeholder="摘要" name="summary">{$vo.summary}</textarea></div>
		        <div class="clear"></div>
	        </div>
	        <div class="formRow">
		        <div class="grid2" ><label>关键字:</label></div>
		        <div class="grid9"><input type="text" name="keyword" value="{$vo.keyword}" placeholder="关键字，多个用半角逗号',' 隔开"></div>
		        <div class="clear"></div>
	        </div>
	        <div class="formRow">
		        <div class="grid2" ><label>内容:</label></div>
		        <div class="grid9">
		        	<a class="buttonS bDefault mb10 mt5" id="edit_news_insert_localdata" style="display:none;" href="javascript:void(0);" data-type="movie">加载本地缓存</a>
		        	<!--<a class="buttonS bDefault mb10 mt5 js-news-add-script" href="javascript:void(0);" data-type="adv">插入广告</a>
		        	<a class="buttonS bDefault mb10 mt5 js-news-add-script" href="javascript:void(0);" data-type="topic">插入专辑</a>
		        	<a class="buttonS bDefault mb10 mt5 js-news-add-script" href="javascript:void(0);" data-type="user">插入个人中心</a>
		        	<a class="buttonS bDefault mb10 mt5 js-news-add-script" href="javascript:void(0);" data-type="news">插入资讯</a>
		        	--><script id="editor" name="html_content" type="text/plain" style="width:100%;height:500px;"></script>
		        	<div class="clear"></div>
		        </div>
		        <div class="clear"></div>
	        </div>
	        <div class="formRow">
		        <div class="grid2" ><label>上线时间:</label></div>
		        <div class="grid4"><input type="text" onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:00'})" name="online_time" value="{$vo.online_time}"></div>
		        <div class="clear"></div>
	        </div>
	        
	        <div class="formRow">
		        <div class="grid2" ><label>作者:</label></div>
		        <div class="grid4"><input type="text" name="grapher" value="{$vo.grapher}" class="ac-news-grapher" placeholder="可输入ID，或者名称查询，也可直接录入ID" /></div>
		        <div class="clear"></div>
	        </div>
	        
        	<div class="formRow">
        		<div class="grid2"><label>是否启用:</label></div>
                <div class="grid1">
                	<label><input type="radio" name="open" value="1" <eq name="vo.open" value="1">checked="checked"</eq> />是</label>
                </div>
                    <div class="grid4">
                	<label><input type="radio" name="open" value="0" <eq name="vo.open" value="0">checked="checked"</eq> />否</label>
                </div>
            	<div class="clear"></div>
            </div>
            <div class="formRow">
        		<div class="grid2"><label>开启智能匹配:</label></div>
                <div class="grid1">
                	<label><input type="radio" class="js-ckb-zhineng" name="zhineng" value="1" <eq name="vo.zhineng" value="1">checked="checked"</eq>/>是</label>
                </div>
                    <div class="grid4">
                	<label><input type="radio" class="js-ckb-zhineng" name="zhineng" value="0" <eq name="vo.zhineng" value="0">checked="checked"</eq>/>否</label>
                </div>
            	<div class="clear"></div>
            </div>
        	<div class="formRow">
        		<input type="hidden" name="id" value="{$vo.id}"/>
            	<input type="submit" value="提 交" class="buttonM bBlack formSubmit" id="submit_form" /><div class="clear"></div>
            </div>
        	</form>
        </div>
        </div>
        </div>
    <!-- Main content ends -->
    </div>
   <div id="editNews_vo_html_content" style="display:none;">{$vo.html_content}</div>
    
</div>
<!-- Content ends -->
<script type="text/javascript">
(function(){
	
	$('#submit_form').click(function(){
		var check = false;
		$('.js-ckb-zhineng').each(function(){
			if ($(this).attr('checked') == 'checked') {
				check = true;return false;
			}
		});
		if (!check) {
			alert('请选择是否开启智能匹配内容。'); return false;
		}
	});
	
	var options = {
		insert_movie : {
			type : 'movie',
			name : '电影',
			title : '插入一部电影',
			show_info : {
				name:['电影名称 :'],
				bpic:['电影封面（大）:','<img src="','" width="200px"/>'],
				spic:['电影封面（小）:','<img src="','" width="200px"/>'],
			},
			info_value : {
				name:['',''],
				bpic:['<img src="','" class="goto_movie" />'],
				spic:['<img src="','" class="goto_movie" />']
			},
			default_info : ['bpic','<img src="','" class="goto_movie" />'],
			script : function(mid){
				return 'gw2c://{"v":"1","a":2,"p":{"mid":"'+mid+'"}}';
			},
			position:'-930px 0'
		},
		insert_adv : {
			type : 'adv',
			name : '广告',
			title : '插入一部广告',
			show_info : {
				name:['广告名称 :'],
				bpic:['广告封面（大）:','<img src="','" width="200px"/>'],
				spic:['广告封面（小）:','<img src="','" width="200px"/>'],
			},
			info_value : {
				name:['',''],
				bpic:['<img src="','" class="goto_adv" />'],
				spic:['<img src="','" class="goto_adv" />']
			},
			default_info : ['name'],
			script : function(aid){
				return 'gw2c://{"v":"1","a":3,"p":{"aid":"'+aid+'"}}';
			},
			position:'-833px 0'
		},
		insert_topic : {
			type : 'topic',
			name : '专辑',
			title : '插入一部专辑',
			show_info : {
				name:['专辑名称 :'],
				bpic:['专辑封面（大）:','<img src="','" width="200px"/>'],
				spic:['专辑封面（小）:','<img src="','" width="200px"/>'],
			},
			info_value : {
				name:['',''],
				bpic:['<img src="','" class="goto_topic" />'],
				spic:['<img src="','" class="goto_topic" />']
			},
			default_info : ['bpic','<img src="','" class="goto_topic" />'],
			script : function(tid){
				return 'gw2c://{"v":"1","a":4,"p":{"tid":"'+tid+'"}}';
			},
			position:'-906px 0'
		},
		insert_user : {
			type : 'user',
			name : '用户（秘号）',
			title : '插入一个用户中心',
			show_info : {
				name:['用户名称 :'],
				avatar:['用户头像:','<img src="','" width="50px"/>'],
			},
			info_value : {
				name:['',''],
				avatar:['<img src="','" class="goto_user" />'],
			},
			default_info : ['name'],
			script : function(uid){
				return 'gw2c://{"v":"1","a":5,"p":{"uid":"'+uid+'"}}';
			},
			position:'-856px -1px'
		},
			insert_news : {
			type : 'news',
			name : '资讯',
			title : '插入一篇资讯',
			show_info : {
				name:['资讯名称 :'],
				bpic:['资讯封面:','<img src="','" width="200px"/>'],
			},
			info_value : {
				name:['',''],
				bpic:['<img src="','" class="goto_news" />'],
			},
			default_info : ['name'],
			script : function(nid){
				return 'gw2c://{"v":"1","a":1,"p":{"nid":"'+nid+'"}}';
			},
			position:'-880px -1px'
		}
	};
	
	var addNewBtn = function(type){
		UE.registerUI(type, function(editor, uiName) {
		    //注册按钮执行时的command命令，使用命令默认就会带有回退操作
		    editor.registerCommand(uiName, {
		        execCommand: function() {
		            //editor.execCommand('insertHtml', 'sb');
		            //$('body').append($div);
		            var option = options[type];
		            var html = '<div class="fluid">'
		            			+ '<div class="widget nopadding nomargin">'
		            				+ '<div class="body">'
			            				+ option.name + 'ID：<input type="text" id="edit_news_insert_movie_id" style="width:100px;border:1px solid #ccc; background-color:#fff; padding:3px;"/>'
			            				+ '&nbsp;&nbsp;&nbsp;&nbsp;<a id="edit_news_get_movie_info">获取</a>'
		            				+ '</div>'
		            				+ '<input type="hidden" id="edit_news_movie_chose_value"/>'
		            				+ '<div id="edit_news_movie_info" style="width:500px;min-height:200px;"></div>'
		            			+ '</div>'
		            		 + '</div>';
		            art.dialog({
		            	id : 'dialog_edit_news',
		    			title : option.title,
		    			content : html,
		    			ok : function(){
		    				var val = $.trim($('#edit_news_insert_movie_id').val());
		    				if (val=='') {
		    					alert(option.name + 'ID不能为空');return false;
		    				}
		    				var name = $.trim($('#edit_news_movie_chose_value').val());
		    				var script_html = "<a href='"+option.script(val)+"'>"+name+"</a>";
		    				editor.execCommand('insertHtml', script_html,false);
		    			},
		    			padding:10,
		    			cancel:true
		            });
		            
		            if ($('#edit_news_get_movie_info').length > 0) {
		            	$('#edit_news_get_movie_info').unbind('click');
		            	$('#edit_news_get_movie_info').click(function(){
		            		var val = $.trim($('#edit_news_insert_movie_id').val());
		    				if (val=='') {
		    					alert(option.name + 'ID不能为空');return false;
		    				}
		    				$.ajax({
		    					type:'POST',
		    					data:{id:val,type:option.type},
		    					url : '{:U("News/getOneInfo")}',
		    					success:function(rst) {
		    						if (typeof rst !== 'object') {
		    							alert('服务器错误:'+rst);
		    						}
		    						if (rst.rst == 0) {
		    							alert(rst.msg);
		    						} else {
		    							var data = rst.data;
		    							var info_html = '<table id="edit_news_dialog_table" class="tDefault" style="width:100%;">';
		    							for (var a in option.show_info) {
		    								info_html = info_html + '<tr><td>' +option.show_info[a][0]+ '</td><td>'
		    										  + ((option.show_info[a].length > 2) ? (option.show_info[a][1] + data[a] + option.show_info[a][2]) :(data[a])) 
		    										  + '</td>'
		    										  + '<td><a href="javascript:void(0);" '+(a==option.default_info[0]?'class="greenBack"':'')+' onclick="$(\'#edit_news_movie_chose_value\').val($(this).attr(\'data-value\'));$(\'#edit_news_dialog_table .greenBack\').removeClass(\'greenBack\');$(this).addClass(\'greenBack\')" data-value=\'' + option.info_value[a][0] + data[a] + option.info_value[a][1] +  '\'>选择</a></td></tr>';
		    							}
		    							info_html += '</table>';
		    							$('#edit_news_movie_info').html(info_html);
		    							if (option.default_info.length > 1) {
		    								$('#edit_news_movie_chose_value').val(option.default_info[1]+data[option.default_info[0]]+option.default_info[2]);
		    							} else {
		    								$('#edit_news_movie_chose_value').val(data[option.default_info[0]]);
		    							}
		    						}
		    					}
		    				});
		            	});
		            }
		        }
		    });
		    //创建一个button
		    var btn = new UE.ui.Button({
		        //按钮的名字
		        name: uiName,
		        //提示
		        title: '插入' + options[type].name,
		        //添加额外样式，指定icon图标，这里默认使用一个重复的icon
		        cssRules: 'background-position: '+options[type].position+';',
		        //点击时执行的命令
		        onclick: function() {
		            //这里可以不用执行命令,做你自己的操作也可
		            editor.execCommand(uiName);
		        }
		    });
		    //当点到编辑内容上时，按钮要做的状态反射
		    editor.addListener('selectionchange', function() {
		        var state = editor.queryCommandState(uiName);
		        if (state == -1) {
		            btn.setDisabled(true);
		            btn.setChecked(false);
		        } else {
		            btn.setDisabled(false);
		            btn.setChecked(state);
		        }
		    });
		    //因为你是添加button,所以需要返回这个button
		    return btn;
		});
	};
	
	for (var a in options) {
		addNewBtn(a);
	}
  	//实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor',{autoHeightEnabled:false});
  	
  	ue.ready(function(){
  		ue.setContent($('#editNews_vo_html_content').html());
  		setTimeout(function(){
  			var localdata = ue.execCommand( "getlocaldata" );
  	  		if (localdata != '') {
  	  			$('#edit_news_insert_localdata').show().click(function(){ue.setContent(localdata);});
  	  		}
  		},20);
  		// ctrl+e 首行缩进
  		ue.addshortcutkey("Indent", "ctrl+69");
  	});
})();
</script>
<notempty name="graphers">
<script>
(function(){
	var availableTags = ['{:implode("','",$graphers)}'];
	$( ".ac-news-grapher" ).autocomplete({
		source: availableTags
	});	
})();
</script>
</notempty>
<include file="Public:footer" />